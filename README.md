# IaC

æ­¤å°ˆæ¡ˆæ˜¯ç”¨ IaC (Terraform + Terragrunt) ä¾†ç®¡ç† GCP ç›¸é—œè³‡æºä»¥åŠæœå‹™ï¼Œä¸¦é€é GitLab CI/CD ä¾†é€²è¡Œè‡ªå‹•åŒ–éƒ¨ç½²ã€‚

<br>

## å‰æƒ…æè¦

1. æ­¤å°ˆæ¡ˆçš„ IaC Module æœ‰åƒè€ƒå®˜æ–¹çš„ Module æ”¹å¯«ï¼Œæœ‰å°‡ä¸€äº›è‡ªå·±ä¸å¸¸ç”¨åˆ°çš„è¨­å®šçµ¦æ‹”æ‰ï¼Œæ‰€ä»¥ä¸æ˜¯æ‰€æœ‰è¨­å®šéƒ½åœ¨ä¸Šé¢ï¼Œå¦‚æœæœ‰éœ€è¦çš„è©±ï¼Œå¯ä»¥è‡ªè¡Œåƒè€ƒå®˜æ–¹çš„ Module ä¾†æ”¹å¯«ã€‚
2. è¦ä½¿ç”¨æ­¤å°ˆæ¡ˆï¼Œè«‹å…ˆç¢ºå®šç‰ˆæœ¬æ˜¯å¦ç¬¦åˆ Module æ‰€è¦å®šçš„ç‰ˆæœ¬ï¼Œå¦‚æœç‰ˆæœ¬ä¸ç¬¦åˆï¼Œè«‹è‡ªè¡Œå‡ç´šã€‚
3. è«‹å…ˆæª¢æŸ¥æ‰€æœ‰è…³æœ¬æˆ–æ˜¯è¨­å®šï¼Œå°‡ä»¥ä¸‹åƒæ•¸ `[å°ˆæ¡ˆåç¨±]`ã€`[å°ˆæ¡ˆID]`ã€`[å°ˆæ¡ˆåœ°å€]`éƒ½æ”¹æˆè‡ªå·±çš„è¨­å®šï¼Œæ‰èƒ½æ­£å¸¸ä½¿ç”¨ã€‚
4. å…¶é¤˜æ²’æœ‰èª¿æ•´æˆ–å¯«å‡ºçš„å…§å®¹ï¼Œæ­¡è¿é–‹ PR ä¾†è£œå……ï¼Œè¬è¬ã€‚

<br>

# ä½¿ç”¨ç‰ˆæœ¬

- Terraform : v1.5.7
- Terragrunt : 0.53.4
- GitLab : 16.3

<br>

## æ–‡ä»¶ç›®éŒ„

- [IaC ä»‹ç´¹](https://github.com/880831ian/IaC/blob/master/docs/iac-introduce.md)
- [IaC æ¶æ§‹](https://github.com/880831ian/IaC/blob/master/docs/iac-introduce.md)
- [IaC CICD æ¶æ§‹](https://github.com/880831ian/IaC/blob/master/docs/iac-cicd-framework.md)
- [IaC åŒ¯å…¥ã€è½‰æ›è…³æœ¬ä»‹ç´¹](https://github.com/880831ian/IaC/blob/master/docs/iac-import-conversion-scripts.md)
- [IaC å‚™æ³¨](https://github.com/880831ian/IaC/blob/master/docs/iac-remark.md)

<br>

ç‚ºäº†æ–¹ä¾¿é–±è®€ï¼ŒREADME åªæœƒæ”¾ IaC çš„ä½¿ç”¨æ•™å­¸ï¼Œå…¶é¤˜çš„æœƒæ”¶éŒ„åœ¨ docs è³‡æ–™å¤¾ä¸­ï¼Œè«‹ç›´æ¥é»ä¸Šæ–¹ç›®éŒ„å°æ‡‰çš„é€£çµã€‚

<br>

## IaC ä½¿ç”¨æ•™å­¸

å¾ [IaC CICD æ¶æ§‹](https://github.com/880831ian/IaC/blob/master/docs/iac-cicd-framework.md) äº†è§£ IaC çš„ CICD æ¶æ§‹å¾Œï¼Œæ¥ä¸‹ä¾†å°±å¯ä»¥é–‹å§‹ä½¿ç”¨ IaC ğŸ˜‰ã€‚

<br>

(ä»¥ä¸‹éƒ½æœƒç”¨ `[å°ˆæ¡ˆåç¨±]`ã€`[è³‡æº]` ä¾†ä»£æ›¿å¯¦éš›çš„å°ˆæ¡ˆåç¨±ã€è³‡æºï¼Œè«‹å¤§å®¶è‡ªè¡Œæ›¿æ›)

é¦–å…ˆï¼Œå‡è¨­æˆ‘å€‘è¦èª¿æ•´ `[å°ˆæ¡ˆåç¨±]` å°ˆæ¡ˆçš„ gke è³‡æºï¼Œé‚£ä½ éœ€è¦å®Œæˆä»¥ä¸‹çš„å¹¾å€‹æ­¥é©Ÿï¼š

1. å…ˆé€²å…¥ projects è³‡æ–™å¤¾ï¼Œå†é€²åˆ° `[å°ˆæ¡ˆåç¨±]` å°ˆæ¡ˆè³‡æ–™å¤¾ï¼Œå¦‚ä¸‹ï¼š

```
.
â”œâ”€â”€ gke-XXX
â”‚Â Â  â”œâ”€â”€ import.sh (é€™å€‹åªæœ‰ GKE æ‰æœ‰ï¼Œè©³ç´°å¯ä»¥åƒè€ƒ IaC åŒ¯å…¥ã€è½‰æ›è…³æœ¬ä»‹ç´¹)
â”‚Â Â  â””â”€â”€ terragrunt.hcl
â””â”€â”€ terragrunt.hcl
```

(æ­¤ç¯„ä¾‹æ˜¯ GKE è³‡æºï¼Œå…¶ä»–è³‡æºä¹Ÿæ˜¯é¡ä¼¼ï¼Œåªè¦é€²åˆ°å°æ‡‰è³‡æºçš„è³‡æ–™å¤¾å³å¯ï¼Œä¾‹å¦‚ï¼šgke-XXXã€gce-XXXã€filestore-XXX)

<br>

2. åœ¨ `[å°ˆæ¡ˆåç¨±]` å°ˆæ¡ˆåº•ä¸‹æœƒå…ˆçœ‹åˆ°ä¸€å€‹ terragrunt.hcl æª”æ¡ˆï¼Œè©²æª”æ¡ˆæœƒå°‡ iac ç®¡ç†çš„ tfstate.tf backend çš„è¨­å®šå¯«åœ¨é€™ï¼Œè©³ç´°å¯ä»¥åƒè€ƒ [Terraform å¦‚ä½•å¤šäººå…±åŒé–‹ç™¼ (å°‡ tfstate å­˜åœ¨å¾Œç«¯)](https://blog.pin-yi.me/terraform-tfstate/)ï¼Œä»¥åŠä¸€äº›å…±ç”¨è®Šæ•¸ï¼Œ`project_id`ã€`network_project_id`ï¼Œé€™ç¨®æ•´å€‹å°ˆæ¡ˆéƒ½å¯ä»¥ä½¿ç”¨çš„è®Šæ•¸å°±å¯ä»¥æ”¾åœ¨é€™é‚Šã€‚

<br>

3. æ¥è‘—æˆ‘å€‘æ‰“é–‹è¦èª¿æ•´çš„ gke è³‡æºï¼Œä¾‹å¦‚ï¼šgke-XXXï¼Œè£¡é¢æœƒæœ‰ä¸€å€‹ import.sh çš„è…³æœ¬ï¼Œè©²è…³æœ¬ä½¿ç”¨èªªæ˜ï¼Œè«‹åƒè€ƒ [IaC åŒ¯å…¥ã€è½‰æ›è…³æœ¬ä»‹ç´¹](https://github.com/880831ian/IaC/blob/master/docs/iac-import-conversion-scripts.md)ï¼Œä»¥åŠ terragrunt.hcl çš„è¨­å®šæª”æ¡ˆï¼š

```
  .... (çœç•¥) ....

inputs = {
  name                   = "platform-dev"
  zones                  = ["asia-east1-b"]
  release_channel        = "REGULAR"
  master_ipv4_cidr_block = "172.16.0.48/28"

  .... (çœç•¥) ....

  node_pools = [
    {
      name            = "platform-pool"
      machine_type    = "e2-standard-4"
      disk_type       = "pd-standard"
      total_min_count = 2
      total_max_count = 8
    },
    {
      name            = "default-api-pool"
      machine_type    = "e2-highmem-2"
      disk_type       = "pd-standard"
      total_min_count = 0
      total_max_count = 8
    }
  ]

  .... (çœç•¥) ....
}
```

(terragrunt.hcl çš„è¨­å®šæª”æ¡ˆè©³ç´°èªªæ˜ï¼Œå¯ä»¥åƒè€ƒ template è³‡æ–™å¤¾ä¸­ä¸åŒè³‡æºçš„ç¯„ä¾‹ä¾†å¡«å¯«)

<br>

4. æ¥è‘—ï¼Œå‡è¨­æˆ‘å€‘ç¾åœ¨æƒ³èª¿æ•´ platform-pool çš„ autoscaling total_min_countï¼Œå°‡ 2 èª¿æ•´æˆ 3ï¼Œå°‡ MR merge åˆ° main åˆ†æ”¯ï¼Œä¸¦è§¸ç™¼ CICD æµç¨‹ (åªæœ‰ç•°å‹• [è³‡æºé¡å‹]-[è³‡æºåç¨±] è³‡æ–™å¤¾åº•ä¸‹çš„ terragrunt.hcl æœƒæ‰è§¸ç™¼ )ï¼Œè©³ç´°è«‹åƒè€ƒ [IaC CICD æ¶æ§‹](https://github.com/880831ian/IaC/blob/master/docs/iac-cicd-framework.md)ã€‚

![img](images/mWR6BZV.png)

<br>

5. è·‘å®Œå¾Œçš„ pipeline æœƒé•·å¾—åƒä»¥ä¸‹ï¼Œæˆ‘å€‘ä¸»è¦æŸ¥çœ‹ plan ä»¥åŠ apply job å³å¯ï¼Œå…¶é¤˜è©³ç´°è«‹åƒè€ƒ [IaC CICD æ¶æ§‹](https://github.com/880831ian/IaC/blob/master/docs/iac-cicd-framework.md)

![img](images/8xvktJM.png)

<br>

6. æˆ‘å€‘å…ˆé»æ“Š plan çš„ job æŒ‰éˆ•ï¼Œè£¡é¢æœƒé¡¯ç¤ºé€™æ¬¡ç•°å‹•çš„å…§å®¹ï¼š

![img](images/63o90fB.png)

<br>

7. è«‹æª¢æŸ¥ä¸€ä¸‹ï¼Œæ˜¯å¦èˆ‡ä½ æƒ³è¦èª¿æ•´çš„è¨­å®šç›¸åŒï¼Œå¦‚æœæ²’å•é¡Œï¼Œå°±å¯ä»¥é» apply çš„æŒ‰éˆ•ï¼Œé€²è¡Œç•°å‹•ï¼Œ<b>ä½†å¦‚æœæœ‰å‡ºç¾ä»»ä½•çš„ç´…å­—ã€æˆ–æ˜¯ destroy</b>ï¼Œè«‹é›™æ‰‹èˆ‰é«˜ï¼Œå‘¼å«æ”¯æ´ï¼Œåƒè¬åˆ¥åŸ·è¡Œ applyï¼š

![img](images/qQ8AN1y.png)

(æ„Ÿè¬æä¾›ç…§ç‰‡ @BingweiLai )

<br>

8. ç•¶ apply çš„ job æœ‰é †åˆ©å®Œæˆå¾Œï¼Œå¯ä»¥åˆ° GCP é é¢ä¸ŠæŸ¥çœ‹æ˜¯å¦æœ‰ç•°å‹•æˆåŠŸï¼Œå°±å®Œæˆ IaC çš„èª¿æ•´å›‰ ğŸ‰ğŸ‰ã€‚

![img](images/M8RoqmH.png)

<br>

9. æœ€å¾Œï¼Œå¦‚æœ plan å®Œæˆå¾Œï¼Œç™¼ç¾æœ‰éŒ¯èª¤ï¼Œè«‹é‡æ–°æ¨æ–°çš„ commitï¼Œå¾è·‘ç¬¬å››é»çš„æµç¨‹ã€‚å¦å¤–ï¼Œå¦‚æœå·²ç¶“ apply å¾Œï¼Œå†é‡æ–°é»èˆŠçš„ apply job æŒ‰éˆ•æœƒå‡ºç¾éŒ¯èª¤ï¼Œæ„æ€æ˜¯ç‹€æ…‹å·²ç¶“æ”¹è®Šï¼Œæ‰€ä»¥ä¸ç”¨æ“”å¿ƒä¸å°å¿ƒé»åˆ° applyã€‚

![img](images/TcyixSg.png)

<br>

10. ä¸Šç‰ˆæ§è·‘ CICD å‰ï¼Œå¯ä»¥å…ˆæŠŠå°ˆæ¡ˆ Clone åˆ°æœ¬åœ°è·‘ï¼Œç”±æ–¼åœ¨åŸ·è¡Œ plan ä»¥åŠ apply æ™‚ï¼Œæœƒé–æª”ï¼Œå¦‚æœå‡ºç¾ä»¥ä¸‹åœ–ç‰‡éŒ¯èª¤ï¼Œå°±ä»£è¡¨æ­£åœ¨æœ‰äººæ¸¬è©¦ç›¸åŒè³‡æºï¼Œå¯ä»¥ç¨ç­‰ä¸€ä¸‹å†è©¦è©¦çœ‹ï¼š

![img](images/yZXCPoY.png)
